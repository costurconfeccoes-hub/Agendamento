<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Costur Confecções - Sistema de Agendamento</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Todos os estilos CSS anteriores permanecem aqui */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --text: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --admin-color: #8e44ad;
            --completed-color: #27ae60;
        }

        body {
            background-color: #f9f9f9;
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid var(--secondary);
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            margin-bottom: 2px;
            color: white;
        }

        .logo-text p {
            font-style: italic;
            opacity: 0.9;
            font-size: 0.9rem;
            color: white;
        }

        .header-contact {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #FFF;
            font-size: 0.9rem;
        }

        .contact-item i {
            color: #FFF;
            font-size: 0.8rem;
        }

        .contact-item span {
            color: #FFF;
            font-weight: 500;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://images.unsplash.com/photo-1441986300917-64674bd600d8?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 100px 0;
            text-align: center;
        }

        .hero h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .hero p {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto 30px;
        }

        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: white;
            padding: 12px 30px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
        }

        /* Sections */
        section {
            padding: 80px 0;
        }

        .section-title {
            text-align: center;
            margin-bottom: 50px;
            position: relative;
        }

        .section-title h2 {
            font-size: 2.2rem;
            color: var(--primary);
            display: inline-block;
            padding-bottom: 10px;
        }

        .section-title h2::after {
            content: '';
            position: absolute;
            width: 80px;
            height: 3px;
            background-color: var(--secondary);
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Card Styles for Scheduling System */
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .card h2 i {
            margin-right: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        button {
            background: var(--secondary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-cancel {
            background: var(--danger-color);
            padding: 8px 15px;
            font-size: 0.9rem;
            width: auto;
        }
        
        .btn-edit {
            background: var(--warning-color);
            padding: 8px 15px;
            font-size: 0.9rem;
            width: auto;
            margin-right: 10px;
        }
        
        .btn-delete {
            background: var(--danger-color);
            padding: 8px 15px;
            font-size: 0.9rem;
            width: auto;
        }

        .btn-correct {
            background: var(--warning-color);
            padding: 8px 15px;
            font-size: 0.9rem;
            width: auto;
            margin-right: 10px;
        }

        .btn-save {
            background: var(--success-color);
            padding: 8px 15px;
            font-size: 0.9rem;
            width: auto;
            margin-right: 10px;
        }

        .btn-download {
            background: var(--secondary);
            padding: 8px 15px;
            font-size: 0.9rem;
            width: auto;
            margin-right: 10px;
        }

        .btn-complete {
            background: var(--completed-color);
            padding: 8px 15px;
            font-size: 0.9rem;
            width: auto;
            margin-right: 10px;
        }
        
        .calendar-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .calendar {
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .calendar-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .calendar-body {
            padding: 15px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day {
            text-align: center;
            padding: 10px 5px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .calendar-day.header {
            font-weight: bold;
            background-color: #f0f0f0;
            color: var(--dark);
        }
        
        .calendar-day.available {
            background-color: var(--success-color);
            color: white;
            cursor: pointer;
        }
        
        .calendar-day.available:hover {
            background-color: #27ae60;
            transform: scale(1.05);
        }
        
        .calendar-day.unavailable {
            background-color: #eee;
            color: #999;
        }
        
        .calendar-day.booked {
            background-color: var(--danger-color);
            color: white;
        }
        
        .calendar-day.today {
            border: 2px solid var(--secondary);
            font-weight: bold;
            background-color: #fff9e6;
        }
        
        .calendar-day.sunday {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .calendar-day.saturday {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .appointments-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        
        .appointment-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .appointment-item:hover {
            background-color: #f9f9f9;
        }
        
        .appointment-item:last-child {
            border-bottom: none;
        }
        
        .appointment-details {
            flex-grow: 1;
        }
        
        .appointment-dates {
            font-size: 0.9rem;
            color: #666;
        }
        
        .appointment-actions {
            display: flex;
            gap: 10px;
        }
        
        .appointment-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-booked {
            background-color: var(--danger-color);
            color: white;
        }
        
        .status-completed {
            background-color: var(--completed-color);
            color: white;
        }
        
        .status-cancelled {
            background-color: #95a5a6;
            color: white;
        }
        
        .calculation-result {
            background: linear-gradient(135deg, #e8f4fd, #d4e9fa);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--secondary);
        }
        
        .calculation-result h3 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Modal Admin */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal h2 {
            color: var(--admin-color);
            margin-bottom: 20px;
        }
        
        .admin-appointments {
            margin-top: 20px;
        }
        
        .admin-appointment-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-btn {
            background: #ecf0f1;
            color: var(--dark);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .time-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .time-slot {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-slot.selected {
            background-color: var(--secondary);
            color: white;
        }
        
        .time-slot.disabled {
            background-color: #eee;
            color: #999;
            cursor: not-allowed;
        }
        
        .time-slot.available:hover {
            background-color: #e6f0ff;
        }
        
        .hidden {
            display: none;
        }
        
        .schedule-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid var(--warning-color);
        }
        
        .schedule-info h4 {
            color: var(--warning-color);
            margin-bottom: 8px;
        }
        
        .document-number {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-weight: bold;
            text-align: center;
        }
        
        .adjustment-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid var(--warning-color);
        }
        
        .admin-access {
            text-align: center;
            margin-top: 20px;
        }
        
        .admin-btn {
            background: var(--admin-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .admin-btn:hover {
            background: #7d3c98;
            transform: translateY(-2px);
        }

        .close-admin-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .close-admin-btn:hover {
            background: #c0392b;
        }

        .admin-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Form de Correção */
        .correction-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--warning-color);
        }

        .correction-form h4 {
            color: var(--warning-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .correction-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Footer */
        footer {
            background-color: var(--primary);
            color: white;
            padding: 40px 0 20px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-column h3 {
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .footer-column p, .footer-column a {
            margin-bottom: 10px;
            display: block;
            color: #ddd;
            text-decoration: none;
        }

        .footer-column a:hover {
            color: white;
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .social-links a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .social-links a:hover {
            background-color: var(--secondary);
            transform: translateY(-5px);
        }

        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: #aaa;
        }

        /* Tabs para Agendamentos */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .calendar-container {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .appointment-actions {
                flex-direction: column;
            }
            
            .time-slots {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .header-contact {
                align-items: center;
            }

            .hero h2 {
                font-size: 2rem;
            }

            .hero p {
                font-size: 1rem;
            }

            .admin-controls {
                flex-direction: column;
                gap: 10px;
            }

            .close-admin-btn {
                position: static;
                margin-top: 10px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                text-align: center;
            }

            .correction-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .logo-container {
                flex-direction: column;
                text-align: center;
            }

            .logo-text h1 {
                font-size: 1.3rem;
            }

            .logo-text p {
                font-size: 0.8rem;
            }

            .contact-item {
                font-size: 0.8rem;
            }

            .section-title h2 {
                font-size: 1.8rem;
            }
        }
    </style>
    
    <!-- Adicione estas linhas antes do fechamento da tag </head> -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
  // Configuração do Firebase com suas credenciais
  const firebaseConfig = {
    apiKey: "AIzaSyAc1iUDZEjyDOtrY9UT_idP5_TGODIsc9E",
    authDomain: "costur-agendamentos.firebaseapp.com",
    projectId: "costur-agendamentos",
    storageBucket: "costur-agendamentos.firebasestorage.app",
    messagingSenderId: "948222283708",
    appId: "1:948222283708:web:a82876883f247e51ede5b9"
  };

  // Inicialização do Firebase
  let firebaseInitialized = false;
  let db = null;

  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    firebaseInitialized = true;
    console.log("Firebase inicializado com sucesso");
  } catch (error) {
    console.log("Firebase não pôde ser inicializado: ", error);
  }

  // Funções para sincronização com Firebase
  async function syncToFirebase() {
    if (!firebaseInitialized || !db) {
      console.log("Firebase não disponível para sincronização");
      return false;
    }
    
    try {
      console.log("Iniciando sincronização com Firebase...");
      
      // Sincronizar agendamentos
      const appointmentsRef = db.collection('appointments');
      const snapshot = await appointmentsRef.get();
      
      const localAppointments = JSON.parse(localStorage.getItem('appointments')) || [];
      
      // Se não existem dados no Firebase, enviar todos os dados locais
      if (snapshot.empty) {
        console.log("Firebase vazio, enviando dados locais...");
        for (const appointment of localAppointments) {
          await appointmentsRef.doc(appointment.id.toString()).set({
            ...appointment,
            updatedAt: new Date().toISOString()
          });
        }
        console.log("Dados locais enviados para Firebase");
      } else {
        // Se existem dados no Firebase, mesclar com dados locais
        console.log("Mesclando dados Firebase com locais...");
        const firebaseAppointments = [];
        snapshot.forEach(doc => {
          firebaseAppointments.push(doc.data());
        });
        
        // Combinar dados (priorizando Firebase em caso de conflito)
        const mergedAppointments = [...localAppointments];
        
        for (const fbAppointment of firebaseAppointments) {
          const localIndex = mergedAppointments.findIndex(a => a.id === fbAppointment.id);
          if (localIndex === -1) {
            // Agendamento existe apenas no Firebase - adicionar ao local
            mergedAppointments.push(fbAppointment);
          } else {
            // Se o registro do Firebase é mais recente, usar ele
            const fbUpdated = new Date(fbAppointment.updatedAt || 0);
            const localUpdated = new Date(mergedAppointments[localIndex].updatedAt || 0);
            if (fbUpdated > localUpdated) {
              mergedAppointments[localIndex] = fbAppointment;
            }
          }
        }
        
        // Atualizar localStorage com dados mesclados
        localStorage.setItem('appointments', JSON.stringify(mergedAppointments));
        
        // Atualizar Firebase com dados mesclados
        for (const appointment of mergedAppointments) {
          await appointmentsRef.doc(appointment.id.toString()).set({
            ...appointment,
            updatedAt: new Date().toISOString()
          });
        }
        
        console.log("Dados mesclados e sincronizados");
      }
      
      // Sincronizar bookedDates
      const bookedDatesRef = db.collection('config').doc('bookedDates');
      const bookedDatesDoc = await bookedDatesRef.get();
      const localBookedDates = JSON.parse(localStorage.getItem('bookedDates')) || {};
      
      if (!bookedDatesDoc.exists) {
        await bookedDatesRef.set({
          dates: localBookedDates,
          updatedAt: new Date().toISOString()
        });
        console.log("BookedDates enviados para Firebase");
      } else {
        const firebaseBookedDates = bookedDatesDoc.data().dates || {};
        
        // Mesclar bookedDates (Firebase tem prioridade)
        const mergedBookedDates = { ...localBookedDates, ...firebaseBookedDates };
        
        // Atualizar localStorage
        localStorage.setItem('bookedDates', JSON.stringify(mergedBookedDates));
        
        // Atualizar Firebase
        await bookedDatesRef.set({
          dates: mergedBookedDates,
          updatedAt: new Date().toISOString()
        });
        
        console.log("BookedDates mesclados e sincronizados");
      }
      
      console.log("Sincronização com Firebase concluída com sucesso");
      return true;
    } catch (error) {
      console.error("Erro na sincronização com Firebase: ", error);
      return false;
    }
  }

  // Função para salvar um agendamento no Firebase
  async function saveAppointmentToFirebase(appointment) {
    if (!firebaseInitialized || !db) {
      console.log("Firebase não disponível, salvando apenas localmente");
      return false;
    }
    
    try {
      await db.collection('appointments').doc(appointment.id.toString()).set({
        ...appointment,
        updatedAt: new Date().toISOString()
      });
      console.log("Agendamento salvo no Firebase: ", appointment.id);
      return true;
    } catch (error) {
      console.error("Erro ao salvar agendamento no Firebase: ", error);
      return false;
    }
  }

  // Função para salvar bookedDates no Firebase
  async function saveBookedDatesToFirebase() {
    if (!firebaseInitialized || !db) {
      console.log("Firebase não disponível, salvando apenas localmente");
      return false;
    }
    
    try {
      const bookedDates = JSON.parse(localStorage.getItem('bookedDates')) || {};
      await db.collection('config').doc('bookedDates').set({
        dates: bookedDates,
        updatedAt: new Date().toISOString()
      });
      console.log("BookedDates salvos no Firebase");
      return true;
    } catch (error) {
      console.error("Erro ao salvar bookedDates no Firebase: ", error);
      return false;
    }
  }

  // Função para deletar um agendamento do Firebase
  async function deleteAppointmentFromFirebase(appointmentId) {
    if (!firebaseInitialized || !db) {
      console.log("Firebase não disponível, deletando apenas localmente");
      return false;
    }
    
    try {
      await db.collection('appointments').doc(appointmentId.toString()).delete();
      console.log("Agendamento deletado do Firebase: ", appointmentId);
      return true;
    } catch (error) {
      console.error("Erro ao deletar agendamento do Firebase: ", error);
      return false;
    }
  }

  // Sobrescrever funções existentes para incluir sincronização com Firebase

  // 1. Sobrescrever markDaysAsBooked
  const originalMarkDaysAsBooked = window.markDaysAsBooked;
  window.markDaysAsBooked = function(startDate, estimatedDays) {
    // Executar função original
    const result = originalMarkDaysAsBooked(startDate, estimatedDays);
    
    // Sincronizar com Firebase
    saveBookedDatesToFirebase();
    
    return result;
  };

  // 2. Sobrescrever completeAppointment
  const originalCompleteAppointment = window.completeAppointment;
  window.completeAppointment = function(index) {
    if (confirm('Tem certeza que deseja marcar este agendamento como realizado?')) {
      appointments[index].status = 'completed';
      localStorage.setItem('appointments', JSON.stringify(appointments));
      
      // Sincronizar com Firebase
      saveAppointmentToFirebase(appointments[index]);
      
      loadAdminAppointments();
      loadAppointmentsList();
      updateStats();
      alert('Agendamento marcado como realizado!');
    }
  };

  // 3. Sobrescrever cancelAppointment
  const originalCancelAppointment = window.cancelAppointment;
  window.cancelAppointment = function(index) {
    if (confirm('Tem certeza que deseja cancelar este agendamento?')) {
      appointments[index].status = 'cancelled';
      localStorage.setItem('appointments', JSON.stringify(appointments));
      
      // Sincronizar com Firebase
      saveAppointmentToFirebase(appointments[index]);
      
      loadAdminAppointments();
      loadAppointmentsList();
      alert('Agendamento cancelado com sucesso!');
    }
  };

  // 4. Sobrescrever deleteAppointment
  const originalDeleteAppointment = window.deleteAppointment;
  window.deleteAppointment = function(index) {
    if (confirm('Tem certeza que deseja excluir este agendamento?')) {
      const deletedAppointment = appointments[index];
      
      // Remove as datas dos dias ocupados
      const startDate = new Date(deletedAppointment.serviceDate);
      for (let i = 0; i < deletedAppointment.estimatedDays; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        const dateKey = currentDate.toISOString().split('T')[0];
        delete bookedDates[dateKey];
      }
      
      localStorage.setItem('bookedDates', JSON.stringify(bookedDates));
      
      // Deletar do Firebase
      deleteAppointmentFromFirebase(deletedAppointment.id);
      
      appointments.splice(index, 1);
      localStorage.setItem('appointments', JSON.stringify(appointments));
      
      // Atualizar bookedDates no Firebase
      saveBookedDatesToFirebase();
      
      // Atualiza a interface
      loadAdminAppointments();
      loadAppointmentsList();
      generateCalendar(currentMonth, currentYear);
      updateStats();
      alert('Agendamento excluído com sucesso!');
    }
  };

  // 5. Sobrescrever saveCorrection
  const originalSaveCorrection = window.saveCorrection;
  window.saveCorrection = function(index) {
    const appointment = appointments[index];
    
    // Coleta os novos valores
    const scheduledBy = document.getElementById(`correction-scheduled-by-${index}`).value;
    const serviceDate = document.getElementById(`correction-service-date-${index}`).value;
    const quantity = document.getElementById(`correction-quantity-${index}`).value;
    const serviceType = document.getElementById(`correction-service-type-${index}`).value;
    const selectedTimeElement = document.querySelector(`#correction-time-slots-${index} .time-slot.selected`);
    
    if (!selectedTimeElement) {
      alert('Por favor, selecione um horário.');
      return;
    }
    
    const serviceTime = selectedTimeElement.getAttribute('data-time');
    
    // Atualiza o agendamento
    appointment.scheduledBy = scheduledBy;
    appointment.serviceDate = serviceDate;
    appointment.quantity = quantity;
    appointment.serviceType = serviceType;
    appointment.serviceTime = serviceTime;
    appointment.estimatedDays = calculateEstimatedDays(serviceDate, parseInt(quantity));
    
    // Atualiza o localStorage
    localStorage.setItem('appointments', JSON.stringify(appointments));
    
    // Sincroniza com Firebase
    saveAppointmentToFirebase(appointment);
    
    // Atualiza a interface
    loadAdminAppointments();
    loadAppointmentsList();
    updateStats();
    
    // Remove o formulário de correção
    document.getElementById(`correction-form-${index}`).remove();
    
    alert('Correção salva com sucesso!');
  };

  // 6. Modificar o evento de submit do formulário para salvar no Firebase
  document.addEventListener('DOMContentLoaded', function() {
    // Encontrar o formulário e adicionar evento de submit
    const appointmentForm = document.getElementById('appointment-form');
    if (appointmentForm) {
      const originalSubmitHandler = appointmentForm.onsubmit;
      
      appointmentForm.onsubmit = function(e) {
        e.preventDefault();
        
        const clientName = document.getElementById('client-name').value;
        const scheduledBy = document.getElementById('scheduled-by').value;
        const serviceDate = document.getElementById('service-date').value;
        const quantity = document.getElementById('quantity').value;
        const serviceType = document.getElementById('service-type').value;
        const selectedTime = document.querySelector('.time-slot.selected')?.getAttribute('data-time');
        
        if (!selectedTime) {
          alert('Por favor, selecione um horário.');
          return;
        }
        
        // Calcula os dias estimados
        const estimatedDays = calculateEstimatedDays(serviceDate, parseInt(quantity));
        const documentNumber = `DOC-${Date.now().toString().slice(-6)}`;
        
        // Cria o agendamento
        const newAppointment = {
          id: Date.now(),
          clientName,
          scheduledBy,
          serviceDate,
          serviceTime: selectedTime,
          quantity,
          serviceType,
          estimatedDays,
          documentNumber,
          status: 'active',
          createdAt: new Date().toISOString()
        };
        
        // Adiciona ao array de agendamentos
        appointments.push(newAppointment);
        localStorage.setItem('appointments', JSON.stringify(appointments));
        
        // Marca os dias como ocupados no calendário
        markDaysAsBooked(serviceDate, estimatedDays);
        
        // Salva no Firebase
        saveAppointmentToFirebase(newAppointment);
        
        // Gera o PDF automaticamente
        generateAppointmentPDF(newAppointment);
        
        // Atualiza a interface
        generateCalendar(currentMonth, currentYear);
        loadAppointmentsList();
        updateStats();
        
        alert('Agendamento realizado com sucesso! O PDF foi baixado automaticamente.');
        
        // Limpa o formulário
        document.getElementById('appointment-form').reset();
        document.getElementById('time-slots').innerHTML = '';
        document.getElementById('entry-datetime').textContent = '-';
        document.getElementById('completion-datetime').textContent = '-';
        document.getElementById('document-number').textContent = 'Nº do Documento: Aguardando dados...';
        document.getElementById('estimated-days').textContent = '0';
      };
    }

    // Inicializar sincronização quando a página carregar
    setTimeout(() => {
      if (firebaseInitialized) {
        syncToFirebase().then(success => {
          if (success) {
            // Recarregar dados após sincronização
            appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            bookedDates = JSON.parse(localStorage.getItem('bookedDates')) || {};
            
            // Atualizar interface
            loadAppointmentsList();
            generateCalendar(currentMonth, currentYear);
            updateStats();
            
            console.log("Sistema sincronizado com Firebase");
          }
        });
      }
    }, 3000);
  });

  // Adicionar botão de sincronização manual na área administrativa
  function addSyncButtonToAdmin() {
    const adminControls = document.querySelector('.admin-controls');
    if (adminControls && !document.getElementById('sync-button')) {
      const syncButton = document.createElement('button');
      syncButton.id = 'sync-button';
      syncButton.className = 'admin-btn';
      syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> Sincronizar com Nuvem';
      syncButton.onclick = manualSync;
      syncButton.style.marginLeft = '10px';
      
      adminControls.appendChild(syncButton);
    }
  }

  // Função de sincronização manual
  async function manualSync() {
    const button = document.getElementById('sync-button');
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';
    button.disabled = true;
    
    const success = await syncToFirebase();
    
    if (success) {
      // Recarregar dados após sincronização
      appointments = JSON.parse(localStorage.getItem('appointments')) || [];
      bookedDates = JSON.parse(localStorage.getItem('bookedDates')) || {};
      
      // Atualizar interface
      loadAppointmentsList();
      loadAdminAppointments();
      generateCalendar(currentMonth, currentYear);
      updateStats();
      
      alert('Sincronização com a nuvem realizada com sucesso!');
    } else {
      alert('Erro na sincronização. Verifique sua conexão com a internet.');
    }
    
    button.innerHTML = originalText;
    button.disabled = false;
  }

  // Adicionar botão de sincronização quando abrir a área administrativa
  const originalOpenAdmin = window.openAdmin;
  window.openAdmin = function() {
    originalOpenAdmin();
    setTimeout(addSyncButtonToAdmin, 100);
  };
</script>
    
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo-container">
                <div class="logo">
                    <img src="https://i.pinimg.com/1200x/40/a8/e9/40a8e9533769e963fd52ccc646efc7c6.jpg" alt="Costur Confecções" id="logo-image">
                </div>
                <div class="logo-text">
                    <h1>Costur Confecções</h1>
                    <p>Sua marca, nossa costura.</p>
                </div>
            </div>
            <div class="header-contact">
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <span>(81) 9.2140-5569 / (81) 9.9201-4171</span>
                </div>
                <div class="contact-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Rua professor ferrucio, 436, São Francisco - Caruaru/PE</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h2>Sistema de Agendamento</h2>
            <p>Agende seus serviços de costura de forma rápida e prática.</p>
            <a href="#agendamento" class="btn">Fazer Agendamento</a>
        </div>
    </section>

    <!-- Sistema de Agendamento -->
    <section id="agendamento">
        <div class="container">
            <div class="section-title">
                <h2>Agendamento de Serviços</h2>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-calendar-plus"></i> Novo Agendamento</h2>
                <form id="appointment-form">
                    <div class="form-group">
                        <label for="client-name">Nome do Cliente</label>
                        <input type="text" id="client-name" required placeholder="Digite o nome do cliente">
                    </div>
                    
                    <div class="form-group">
                        <label for="scheduled-by">Agendado por</label>
                        <select id="scheduled-by" required>
                            <option value="">Selecione quem está agendando</option>
                            <option value="Wallison Vinicius">Wallison Vinicius</option>
                            <option value="Eduarda Emmanoelly">Eduarda Emmanoelly</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="service-date">Data de Início do Serviço</label>
                        <input type="date" id="service-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity">Quantidade de Peças</label>
                        <input type="number" id="quantity" min="1" value="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="service-type">Tipo de Serviço</label>
                        <select id="service-type" required>
                            <option value="">Selecione o tipo de serviço</option>
                            <option value="confecção completa">Confecção completa</option>
                            <option value="Confecção parcial">Confecção parcial</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Horário de Início</label>
                        <div class="time-slots" id="time-slots">
                            <!-- Horários serão gerados via JavaScript -->
                        </div>
                    </div>
                    
                    <div class="schedule-info">
                        <h4><i class="fas fa-info-circle"></i> Informações do Agendamento</h4>
                        <p><strong>Data e Hora de Entrada:</strong> <span id="entry-datetime">-</span></p>
                        <p><strong>Data Estipulada para Término:</strong> <span id="completion-datetime">-</span></p>
                        <div class="document-number" id="document-number">
                            Nº do Documento: Aguardando dados...
                        </div>
                    </div>
                    
                    <div class="calculation-result" id="calculation-result">
                        <h3>Detalhes do Serviço</h3>
                        <p><strong>Dias estimados para conclusão:</strong> <span id="estimated-days">0</span> dias</p>
                    </div>
                    
                    <button type="submit" id="submit-btn">Agendar Serviço</button>
                </form>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-appointments">0</div>
                    <div class="stat-label">Agendamentos Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-pieces">0</div>
                    <div class="stat-label">Peças em Produção</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="occupied-days">0</div>
                    <div class="stat-label">Dias Ocupados</div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-calendar-alt"></i> Calendário de Disponibilidade</h2>
                <div class="calendar-container">
                    <div class="calendar">
                        <div class="calendar-header" id="current-month">Carregando...</div>
                        <div class="calendar-body">
                            <div class="calendar-grid" id="calendar-days">
                                <!-- Dias serão gerados via JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3>Legenda</h3>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color available"></div>
                                <span>Disponível para agendamento</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color booked"></div>
                                <span>Período ocupado</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color today"></div>
                                <span>Dia atual</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color sunday"></div>
                                <span>Domingo (horário normal)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color saturday"></div>
                                <span>Sábado (meio período)</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button id="prev-month">Mês Anterior</button>
                            <button id="next-month" style="margin-top: 10px;">Próximo Mês</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-list"></i> Agendamentos</h2>
                
                <!-- Tabs para Agendamentos Ativos, Realizados e Cancelados -->
                <div class="tabs">
                    <button class="tab active" data-tab="active">Agendamentos Ativos</button>
                    <button class="tab" data-tab="completed">Agendamentos Realizados</button>
                    <button class="tab" data-tab="cancelled">Agendamentos Cancelados</button>
                </div>
                
                <div class="tab-content active" id="active-appointments">
                    <div class="appointments-list" id="appointments-list">
                        <!-- Agendamentos ativos serão gerados via JavaScript -->
                    </div>
                </div>
                
                <div class="tab-content" id="completed-appointments">
                    <div class="appointments-list" id="completed-list">
                        <!-- Agendamentos realizados serão gerados via JavaScript -->
                    </div>
                </div>
                
                <div class="tab-content" id="cancelled-appointments">
                    <div class="appointments-list" id="cancelled-list">
                        <!-- Agendamentos cancelados serão gerados via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>Costur Confecções</h3>
                    <p>Sua marca, nossa costura. Oferecemos serviços de confecção com qualidade e agilidade.</p>
                    <div class="social-links">
                        <a href="https://www.instagram.com/costurconfeccoes"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                <div class="footer-column">
                    <h3>Contato</h3>
                    <p><i class="fas fa-phone"></i> (81) 9.2140-5569</p>
                    <p><i class="fas fa-phone"></i> (81) 9.9201-4171</p>
                    <p><i class="fas fa-map-marker-alt"></i> Rua professor ferrucio, 436, São Francisco - Caruaru/PE</p>
                </div>
                <div class="footer-column">
                    <h3>Horário de Funcionamento</h3>
                    <p>Segunda a Sexta: 08:00 às 12:00 - 14:00 às 18:00</p>
                    <p>Sábado: 08:00 às 14:00</p>
                    <p>Domingo: Fechado</p>
                </div>
            </div>
            
            <!-- Botão da Área Administrativa no rodapé -->
            <div class="admin-access">
                <button class="admin-btn" onclick="openAdmin()">
                    <i class="fas fa-tools"></i> Área Administrativa
                </button>
            </div>
            
            <div class="copyright">
                &copy; 2023 Costur Confecções. Todos os direitos reservados.
            </div>
        </div>
    </footer>

    <!-- Modal Administrativo -->
    <div class="modal" id="admin-modal">
        <div class="modal-content">
            <div class="admin-controls">
                <h2><i class="fas fa-tools"></i> Área Administrativa</h2>
                <button class="close-admin-btn" onclick="closeAdmin()">
                    <i class="fas fa-times"></i> Sair
                </button>
            </div>
            
            <div id="admin-login">
                <div class="form-group">
                    <label for="admin-password">Senha de Acesso:</label>
                    <input type="password" id="admin-password" placeholder="Digite a senha administrativa">
                    <button onclick="verifyAdminPassword()">Acessar</button>
                </div>
            </div>
            
            <div id="admin-content" class="hidden">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Todos</button>
                    <button class="filter-btn" data-filter="active">Ativos</button>
                    <button class="filter-btn" data-filter="completed">Realizados</button>
                    <button class="filter-btn" data-filter="cancelled">Cancelados</button>
                </div>
                
                <div class="admin-appointments" id="admin-appointments">
                    <!-- Agendamentos administrativos serão gerados via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Armazenamento de agendamentos
        let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
        let bookedDates = JSON.parse(localStorage.getItem('bookedDates')) || {};
        let currentEditingIndex = null;
        let currentFilter = 'all';

        // Variáveis globais para o calendário
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        // Função para calcular dias estimados considerando finais de semana
        function calculateEstimatedDays(startDate, quantity) {
            let baseDays = (quantity / 45) + 1;
            let totalDays = Math.ceil(baseDays);
            
            let currentDate = new Date(startDate);
            let weekendDays = 0;
            
            for (let i = 0; i < totalDays; i++) {
                let checkDate = new Date(currentDate);
                checkDate.setDate(currentDate.getDate() + i);
                let dayOfWeek = checkDate.getDay();
                
                if (dayOfWeek === 6) {
                    weekendDays += 0.25;
                }
                else if (dayOfWeek === 0) {
                    weekendDays += 1;
                }
            }
            
            totalDays += weekendDays;
            return Math.ceil(totalDays);
        }

        // Função para calcular a data de término
        function calculateCompletionDate(startDate, estimatedDays) {
            let completionDate = new Date(startDate);
            completionDate.setDate(completionDate.getDate() + estimatedDays);
            return completionDate;
        }

        // Função para marcar dias como ocupados no calendário
        function markDaysAsBooked(startDate, estimatedDays) {
            const start = new Date(startDate);
            
            for (let i = 0; i < estimatedDays; i++) {
                const currentDate = new Date(start);
                currentDate.setDate(start.getDate() + i);
                
                const dateKey = currentDate.toISOString().split('T')[0];
                bookedDates[dateKey] = true;
            }
            
            localStorage.setItem('bookedDates', JSON.stringify(bookedDates));
        }

        // Função para gerar PDF do agendamento
        function generateAppointmentPDF(appointment) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Formata a data para o nome do arquivo
            const dateForFilename = appointment.serviceDate.split('-').reverse().join('-');
            const filename = `${appointment.clientName} - ${dateForFilename}.pdf`;
            
            // Adiciona conteúdo ao PDF
            doc.setFontSize(20);
            doc.setTextColor(44, 62, 80);
            doc.text('Costur Confecções', 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setTextColor(52, 152, 219);
            doc.text('Comprovante de Agendamento', 105, 35, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPosition = 60;
            
            // Informações do agendamento
            doc.text(`Cliente: ${appointment.clientName}`, 20, yPosition);
            yPosition += 10;
            
            doc.text(`Agendado por: ${appointment.scheduledBy}`, 20, yPosition);
            yPosition += 10;
            
            doc.text(`Data de Início: ${appointment.serviceDate}`, 20, yPosition);
            yPosition += 10;
            
            doc.text(`Horário: ${appointment.serviceTime}`, 20, yPosition);
            yPosition += 10;
            
            doc.text(`Quantidade de Peças: ${appointment.quantity}`, 20, yPosition);
            yPosition += 10;
            
            doc.text(`Tipo de Serviço: ${appointment.serviceType}`, 20, yPosition);
            yPosition += 10;
            
            doc.text(`Dias Estimados: ${appointment.estimatedDays} dias`, 20, yPosition);
            yPosition += 10;
            
            const completionDate = calculateCompletionDate(appointment.serviceDate, appointment.estimatedDays);
            doc.text(`Data de Término: ${completionDate.toLocaleDateString('pt-BR')}`, 20, yPosition);
            yPosition += 15;
            
            doc.text(`Nº do Documento: ${appointment.documentNumber || 'DOC-' + appointment.id.toString().slice(-6)}`, 20, yPosition);
            yPosition += 20;
            
            // Rodapé
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Costur Confecções - Sua marca, nossa costura', 105, 280, { align: 'center' });
            doc.text('Rua professor ferrucio, 436, São Francisco - Caruaru/PE', 105, 285, { align: 'center' });
            
            // Salva o PDF
            doc.save(filename);
        }

        // Função para mostrar formulário de correção
        function showCorrectionForm(index) {
            currentEditingIndex = index;
            const appointment = appointments[index];
            
            const correctionFormHTML = `
                <div class="correction-form" id="correction-form-${index}">
                    <h4><i class="fas fa-edit"></i> Corrigir Agendamento</h4>
                    
                    <div class="form-group">
                        <label>Cliente (não editável)</label>
                        <input type="text" value="${appointment.clientName}" disabled style="background-color: #f5f5f5;">
                    </div>
                    
                    <div class="form-group">
                        <label for="correction-scheduled-by-${index}">Agendado por</label>
                        <select id="correction-scheduled-by-${index}">
                            <option value="Wallison Vinicius" ${appointment.scheduledBy === 'Wallison Vinicius' ? 'selected' : ''}>Wallison Vinicius</option>
                            <option value="Eduarda Emmanoelly" ${appointment.scheduledBy === 'Eduarda Emmanoelly' ? 'selected' : ''}>Eduarda Emmanoelly</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="correction-service-date-${index}">Data de Início</label>
                        <input type="date" id="correction-service-date-${index}" value="${appointment.serviceDate}">
                    </div>
                    
                    <div class="form-group">
                        <label for="correction-quantity-${index}">Quantidade de Peças</label>
                        <input type="number" id="correction-quantity-${index}" value="${appointment.quantity}" min="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="correction-service-type-${index}">Tipo de Serviço</label>
                        <select id="correction-service-type-${index}">
                            <option value="confecção completa" ${appointment.serviceType === 'confecção completa' ? 'selected' : ''}>Confecção completa</option>
                            <option value="Confecção parcial" ${appointment.serviceType === 'Confecção parcial' ? 'selected' : ''}>Confecção parcial</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Horário de Início</label>
                        <div class="time-slots" id="correction-time-slots-${index}">
                            ${generateTimeSlotsForCorrection(appointment.serviceTime)}
                        </div>
                    </div>
                    
                    <div class="correction-actions">
                        <button type="button" class="btn-save" onclick="saveCorrection(${index})">
                            <i class="fas fa-save"></i> Salvar Correção
                        </button>
                        <button type="button" class="btn-cancel" onclick="cancelCorrection(${index})">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            // Remove qualquer formulário de correção existente
            document.querySelectorAll('.correction-form').forEach(form => form.remove());
            
            // Adiciona o novo formulário após o item do agendamento
            const appointmentItem = document.querySelector(`[data-appointment-index="${index}"]`);
            appointmentItem.insertAdjacentHTML('afterend', correctionFormHTML);
            
            // Adiciona eventos aos time slots
            document.querySelectorAll(`#correction-time-slots-${index} .time-slot`).forEach(slot => {
                slot.addEventListener('click', function() {
                    document.querySelectorAll(`#correction-time-slots-${index} .time-slot.selected`).forEach(s => {
                        s.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
        }

        // Função para gerar time slots para correção
        function generateTimeSlotsForCorrection(selectedTime) {
            const timeSlots = ['08:00', '09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
            let html = '';
            
            timeSlots.forEach(time => {
                const isSelected = time === selectedTime ? 'selected' : '';
                html += `<div class="time-slot available ${isSelected}" data-time="${time}">${time}</div>`;
            });
            
            return html;
        }

        // Função para salvar correção
        function saveCorrection(index) {
            const appointment = appointments[index];
            
            // Coleta os novos valores
            const scheduledBy = document.getElementById(`correction-scheduled-by-${index}`).value;
            const serviceDate = document.getElementById(`correction-service-date-${index}`).value;
            const quantity = document.getElementById(`correction-quantity-${index}`).value;
            const serviceType = document.getElementById(`correction-service-type-${index}`).value;
            const selectedTimeElement = document.querySelector(`#correction-time-slots-${index} .time-slot.selected`);
            
            if (!selectedTimeElement) {
                alert('Por favor, selecione um horário.');
                return;
            }
            
            const serviceTime = selectedTimeElement.getAttribute('data-time');
            
            // Atualiza o agendamento
            appointment.scheduledBy = scheduledBy;
            appointment.serviceDate = serviceDate;
            appointment.quantity = quantity;
            appointment.serviceType = serviceType;
            appointment.serviceTime = serviceTime;
            appointment.estimatedDays = calculateEstimatedDays(serviceDate, parseInt(quantity));
            
            // Atualiza o localStorage
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            // Atualiza a interface
            loadAdminAppointments();
            loadAppointmentsList();
            updateStats();
            
            // Remove o formulário de correção
            document.getElementById(`correction-form-${index}`).remove();
            
            alert('Correção salva com sucesso!');
        }

        // Função para cancelar correção
        function cancelCorrection(index) {
            document.getElementById(`correction-form-${index}`).remove();
        }

        // Funções JavaScript para o sistema de agendamento
        function openAdmin() {
            document.getElementById('admin-modal').style.display = 'flex';
            document.getElementById('admin-content').classList.add('hidden');
            document.getElementById('admin-login').classList.remove('hidden');
            document.getElementById('admin-password').value = '';
        }
        
        function closeAdmin() {
            document.getElementById('admin-modal').style.display = 'none';
        }
        
        function verifyAdminPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === "CosturADM2023") {
                document.getElementById('admin-content').classList.remove('hidden');
                document.getElementById('admin-login').classList.add('hidden');
                loadAdminAppointments();
            } else {
                alert("Senha incorreta!");
            }
        }

        function loadAdminAppointments() {
            const adminAppointmentsContainer = document.getElementById('admin-appointments');
            
            if (appointments.length === 0) {
                adminAppointmentsContainer.innerHTML = '<p>Nenhum agendamento encontrado.</p>';
                return;
            }
            
            let adminAppointmentsHTML = '';
            
            appointments.forEach((appointment, index) => {
                // Aplicar filtro
                if (currentFilter !== 'all' && appointment.status !== currentFilter) {
                    return;
                }
                
                let statusClass = 'status-booked';
                let statusText = 'Agendado';
                
                if (appointment.status === 'cancelled') {
                    statusClass = 'status-cancelled';
                    statusText = 'Cancelado';
                } else if (appointment.status === 'completed') {
                    statusClass = 'status-completed';
                    statusText = 'Realizado';
                }
                
                adminAppointmentsHTML += `
                    <div class="admin-appointment-item" data-appointment-index="${index}">
                        <div class="appointment-details">
                            <h4>${appointment.clientName}</h4>
                            <p><strong>Agendado por:</strong> ${appointment.scheduledBy}</p>
                            <p><strong>Data:</strong> ${appointment.serviceDate} às ${appointment.serviceTime}</p>
                            <p><strong>Peças:</strong> ${appointment.quantity} | <strong>Tipo:</strong> ${appointment.serviceType}</p>
                            <p><strong>Dias estimados:</strong> ${appointment.estimatedDays} dias</p>
                            <div class="appointment-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="appointment-actions">
                            ${appointment.status === 'active' ? `
                                <button class="btn-complete" onclick="completeAppointment(${index})">Marcar como Realizado</button>
                                <button class="btn-correct" onclick="showCorrectionForm(${index})">Corrigir</button>
                                <button class="btn-cancel" onclick="cancelAppointment(${index})">Cancelar</button>
                            ` : ''}
                            <button class="btn-delete" onclick="deleteAppointment(${index})">Excluir</button>
                        </div>
                    </div>
                `;
            });
            
            adminAppointmentsContainer.innerHTML = adminAppointmentsHTML;
        }

        // Função para marcar agendamento como realizado
        function completeAppointment(index) {
            if (confirm('Tem certeza que deseja marcar este agendamento como realizado?')) {
                appointments[index].status = 'completed';
                localStorage.setItem('appointments', JSON.stringify(appointments));
                loadAdminAppointments();
                loadAppointmentsList();
                updateStats();
                alert('Agendamento marcado como realizado!');
            }
        }
        
        function cancelAppointment(index) {
            if (confirm('Tem certeza que deseja cancelar este agendamento?')) {
                appointments[index].status = 'cancelled';
                localStorage.setItem('appointments', JSON.stringify(appointments));
                loadAdminAppointments();
                loadAppointmentsList();
                alert('Agendamento cancelado com sucesso!');
            }
        }
        
        function deleteAppointment(index) {
            if (confirm('Tem certeza que deseja excluir este agendamento?')) {
                const deletedAppointment = appointments[index];
                
                // Remove as datas dos dias ocupados
                const startDate = new Date(deletedAppointment.serviceDate);
                for (let i = 0; i < deletedAppointment.estimatedDays; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    const dateKey = currentDate.toISOString().split('T')[0];
                    delete bookedDates[dateKey];
                }
                
                localStorage.setItem('bookedDates', JSON.stringify(bookedDates));
                
                appointments.splice(index, 1);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                // Atualiza a interface
                loadAdminAppointments();
                loadAppointmentsList();
                generateCalendar(currentMonth, currentYear);
                updateStats();
                alert('Agendamento excluído com sucesso!');
            }
        }

        // Função para carregar agendamentos na lista principal
        function loadAppointmentsList() {
            const activeAppointmentsContainer = document.getElementById('appointments-list');
            const completedAppointmentsContainer = document.getElementById('completed-list');
            const cancelledAppointmentsContainer = document.getElementById('cancelled-list');
            
            const activeAppointments = appointments.filter(a => a.status === 'active');
            const completedAppointments = appointments.filter(a => a.status === 'completed');
            const cancelledAppointments = appointments.filter(a => a.status === 'cancelled');
            
            // Agendamentos Ativos
            if (activeAppointments.length === 0) {
                activeAppointmentsContainer.innerHTML = '<p style="padding: 20px; text-align: center;">Nenhum agendamento ativo encontrado.</p>';
            } else {
                let activeHTML = '';
                activeAppointments.forEach((appointment, index) => {
                    activeHTML += `
                        <div class="appointment-item">
                            <div class="appointment-details">
                                <h4>${appointment.clientName}</h4>
                                <p><strong>Data:</strong> ${appointment.serviceDate} às ${appointment.serviceTime}</p>
                                <p><strong>Peças:</strong> ${appointment.quantity} | <strong>Tipo:</strong> ${appointment.serviceType}</p>
                                <p><strong>Previsão de Término:</strong> ${calculateCompletionDate(appointment.serviceDate, appointment.estimatedDays).toLocaleDateString('pt-BR')}</p>
                                <div class="appointment-status status-booked">Agendado</div>
                            </div>
                            <div class="appointment-actions">
                                <button class="btn-download" onclick="downloadAppointmentPDF(${appointments.indexOf(appointment)})">
                                    <i class="fas fa-download"></i> PDF
                                </button>
                            </div>
                        </div>
                    `;
                });
                activeAppointmentsContainer.innerHTML = activeHTML;
            }
            
            // Agendamentos Realizados
            if (completedAppointments.length === 0) {
                completedAppointmentsContainer.innerHTML = '<p style="padding: 20px; text-align: center;">Nenhum agendamento realizado encontrado.</p>';
            } else {
                let completedHTML = '';
                completedAppointments.forEach((appointment, index) => {
                    completedHTML += `
                        <div class="appointment-item">
                            <div class="appointment-details">
                                <h4>${appointment.clientName}</h4>
                                <p><strong>Data:</strong> ${appointment.serviceDate} às ${appointment.serviceTime}</p>
                                <p><strong>Peças:</strong> ${appointment.quantity} | <strong>Tipo:</strong> ${appointment.serviceType}</p>
                                <div class="appointment-status status-completed">Realizado</div>
                            </div>
                        </div>
                    `;
                });
                completedAppointmentsContainer.innerHTML = completedHTML;
            }
            
            // Agendamentos Cancelados
            if (cancelledAppointments.length === 0) {
                cancelledAppointmentsContainer.innerHTML = '<p style="padding: 20px; text-align: center;">Nenhum agendamento cancelado encontrado.</p>';
            } else {
                let cancelledHTML = '';
                cancelledAppointments.forEach((appointment, index) => {
                    cancelledHTML += `
                        <div class="appointment-item">
                            <div class="appointment-details">
                                <h4>${appointment.clientName}</h4>
                                <p><strong>Data:</strong> ${appointment.serviceDate} às ${appointment.serviceTime}</p>
                                <p><strong>Peças:</strong> ${appointment.quantity} | <strong>Tipo:</strong> ${appointment.serviceType}</p>
                                <div class="appointment-status status-cancelled">Cancelado</div>
                            </div>
                        </div>
                    `;
                });
                cancelledAppointmentsContainer.innerHTML = cancelledHTML;
            }
        }

        // Função para download do PDF
        function downloadAppointmentPDF(index) {
            const appointment = appointments[index];
            generateAppointmentPDF(appointment);
        }
        
        // Função para gerar o calendário - CORRIGIDA
        function generateCalendar(month, year) {
            try {
                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                                   "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                
                document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const today = new Date();
                const currentDay = today.getDate();
                const currentMonthToday = today.getMonth();
                const currentYearToday = today.getFullYear();
                
                const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
                let calendarHTML = '';
                
                // Cabeçalho com dias da semana
                dayNames.forEach(day => {
                    calendarHTML += `<div class="calendar-day header">${day}</div>`;
                });
                
                // Dias vazios no início
                for (let i = 0; i < firstDay; i++) {
                    calendarHTML += `<div class="calendar-day unavailable"></div>`;
                }
                
                // Dias do mês
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    let dayClass = "calendar-day available";
                    
                    // Verifica se está ocupado
                    if (bookedDates[dateKey]) {
                        dayClass = "calendar-day booked";
                    }
                    
                    // Verifica se é hoje
                    if (day === currentDay && month === currentMonthToday && year === currentYearToday) {
                        dayClass += " today";
                    }
                    
                    // Verifica se é domingo
                    if (new Date(year, month, day).getDay() === 0) {
                        dayClass += " sunday";
                    }
                    
                    // Verifica se é sábado
                    if (new Date(year, month, day).getDay() === 6) {
                        dayClass += " saturday";
                    }
                    
                    calendarHTML += `<div class="${dayClass}" data-day="${day}" data-month="${month}" data-year="${year}">${day}</div>`;
                }
                
                document.getElementById('calendar-days').innerHTML = calendarHTML;
                
                // Adiciona eventos de clique aos dias disponíveis
                document.querySelectorAll('.calendar-day.available').forEach(day => {
                    day.addEventListener('click', function() {
                        const selectedDay = this.getAttribute('data-day');
                        const selectedMonth = parseInt(this.getAttribute('data-month')) + 1;
                        const selectedYear = this.getAttribute('data-year');
                        
                        const formattedDate = `${selectedYear}-${selectedMonth.toString().padStart(2, '0')}-${selectedDay.padStart(2, '0')}`;
                        document.getElementById('service-date').value = formattedDate;
                        updateTimeSlots();
                    });
                });
                
            } catch (error) {
                console.error("Erro ao gerar calendário:", error);
                document.getElementById('current-month').textContent = "Erro ao carregar";
                document.getElementById('calendar-days').innerHTML = '<div class="calendar-day">Erro</div>';
            }
        }
        
        // Função para atualizar os horários disponíveis
        function updateTimeSlots() {
            const timeSlotsContainer = document.getElementById('time-slots');
            const timeSlots = [
                '08:00', '09:00', '10:00', '11:00', 
                '14:00', '15:00', '16:00', '17:00'
            ];
            
            let timeSlotsHTML = '';
            
            timeSlots.forEach(time => {
                timeSlotsHTML += `<div class="time-slot available" data-time="${time}">${time}</div>`;
            });
            
            timeSlotsContainer.innerHTML = timeSlotsHTML;
            
            document.querySelectorAll('.time-slot.available').forEach(slot => {
                slot.addEventListener('click', function() {
                    document.querySelectorAll('.time-slot.selected').forEach(s => {
                        s.classList.remove('selected');
                    });
                    
                    this.classList.add('selected');
                    updateScheduleInfo();
                });
            });
        }
        
        // Função para atualizar as informações do agendamento
        function updateScheduleInfo() {
            const serviceDate = document.getElementById('service-date').value;
            const selectedTime = document.querySelector('.time-slot.selected')?.getAttribute('data-time');
            const quantity = document.getElementById('quantity').value;
            
            if (serviceDate && selectedTime && quantity) {
                const entryDateTime = `${serviceDate.split('-').reverse().join('/')} às ${selectedTime}`;
                document.getElementById('entry-datetime').textContent = entryDateTime;
                
                const estimatedDays = calculateEstimatedDays(serviceDate, parseInt(quantity));
                document.getElementById('estimated-days').textContent = estimatedDays;
                
                const completionDate = calculateCompletionDate(serviceDate, estimatedDays);
                const formattedCompletionDate = completionDate.toLocaleDateString('pt-BR');
                document.getElementById('completion-datetime').textContent = formattedCompletionDate;
                
                const docNumber = `DOC-${Date.now().toString().slice(-6)}`;
                document.getElementById('document-number').textContent = `Nº do Documento: ${docNumber}`;
            }
        }
        
        // Função para atualizar estatísticas
        function updateStats() {
            const activeAppointments = appointments.filter(a => a.status === 'active').length;
            const totalPieces = appointments.reduce((sum, appointment) => {
                if (appointment.status === 'active') {
                    return sum + parseInt(appointment.quantity);
                }
                return sum;
            }, 0);
            
            const uniqueDates = new Set();
            appointments.forEach(appointment => {
                if (appointment.status === 'active') {
                    uniqueDates.add(appointment.serviceDate);
                }
            });
            
            document.getElementById('total-appointments').textContent = activeAppointments;
            document.getElementById('total-pieces').textContent = totalPieces;
            document.getElementById('occupied-days').textContent = uniqueDates.size;
        }
        
        // Inicialização do sistema
        document.addEventListener('DOMContentLoaded', function() {
            // Gera o calendário inicial
            generateCalendar(currentMonth, currentYear);
            
            // Define a data mínima para o campo de data como hoje
            const today = new Date();
            const minDate = today.toISOString().split('T')[0];
            document.getElementById('service-date').min = minDate;
            
            // Adiciona eventos aos botões de navegação do calendário
            document.getElementById('prev-month').addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                generateCalendar(currentMonth, currentYear);
            });
            
            document.getElementById('next-month').addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                generateCalendar(currentMonth, currentYear);
            });
            
            // Atualiza os horários quando a data é alterada
            document.getElementById('service-date').addEventListener('change', updateTimeSlots);
            
            // Atualiza as informações quando a quantidade é alterada
            document.getElementById('quantity').addEventListener('change', updateScheduleInfo);
            
            // Adiciona evento de envio do formulário
            document.getElementById('appointment-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const clientName = document.getElementById('client-name').value;
                const scheduledBy = document.getElementById('scheduled-by').value;
                const serviceDate = document.getElementById('service-date').value;
                const quantity = document.getElementById('quantity').value;
                const serviceType = document.getElementById('service-type').value;
                const selectedTime = document.querySelector('.time-slot.selected')?.getAttribute('data-time');
                
                if (!selectedTime) {
                    alert('Por favor, selecione um horário.');
                    return;
                }
                
                // Calcula os dias estimados
                const estimatedDays = calculateEstimatedDays(serviceDate, parseInt(quantity));
                const documentNumber = `DOC-${Date.now().toString().slice(-6)}`;
                
                // Cria o agendamento
                const newAppointment = {
                    id: Date.now(),
                    clientName,
                    scheduledBy,
                    serviceDate,
                    serviceTime: selectedTime,
                    quantity,
                    serviceType,
                    estimatedDays,
                    documentNumber,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                // Adiciona ao array de agendamentos
                appointments.push(newAppointment);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                // Marca os dias como ocupados no calendário
                markDaysAsBooked(serviceDate, estimatedDays);
                
                // Gera o PDF automaticamente
                generateAppointmentPDF(newAppointment);
                
                // Atualiza a interface
                generateCalendar(currentMonth, currentYear);
                loadAppointmentsList();
                updateStats();
                
                alert('Agendamento realizado com sucesso! O PDF foi baixado automaticamente.');
                
                // Limpa o formulário
                document.getElementById('appointment-form').reset();
                document.getElementById('time-slots').innerHTML = '';
                document.getElementById('entry-datetime').textContent = '-';
                document.getElementById('completion-datetime').textContent = '-';
                document.getElementById('document-number').textContent = 'Nº do Documento: Aguardando dados...';
                document.getElementById('estimated-days').textContent = '0';
            });
            
            // Sistema de tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove a classe active de todas as tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    // Adiciona a classe active à tab clicada
                    this.classList.add('active');
                    
                    // Esconde todos os conteúdos
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Mostra o conteúdo correspondente
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-appointments`).classList.add('active');
                });
            });
            
            // Sistema de filtros na área administrativa
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove a classe active de todos os botões
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    // Adiciona a classe active ao botão clicado
                    this.classList.add('active');
                    
                    // Define o filtro atual
                    currentFilter = this.getAttribute('data-filter');
                    
                    // Atualiza a lista de agendamentos
                    loadAdminAppointments();
                });
            });
            
            // Atualiza estatísticas iniciais e lista de agendamentos
            updateStats();
            loadAppointmentsList();
        });
    </script>
</body>
</html>
